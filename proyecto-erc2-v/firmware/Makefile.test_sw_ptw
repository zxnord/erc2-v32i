# Makefile for the Software PTW test

# --- Compiler Configuration ---
CROSS_COMPILE ?= riscv64-unknown-elf-

# The name of the final binary
TARGET      = test_sw_ptw

# Tools
CC = $(CROSS_COMPILE)gcc
OBJCOPY = $(CROSS_COMPILE)objcopy

# --- Source Files ---
SOURCES = test_sw_ptw.S
OBJS = $(SOURCES:.S=.o)

# --- Compilation Options ---
CFLAGS = -march=rv32imazicsr -mabi=ilp32 -O0 -g -nostdlib -Tlinker.ld

# --- Makefile Rules ---
.PHONY: all clean

# The default target is to build the .hex file
all: $(TARGET).hex

# Rule to convert the binary to clean Verilog HEX format
$(TARGET).hex: $(TARGET).bin
	./bin_to_hex.py $^ $@

# Rule to extract the raw binary from the ELF file
$(TARGET).bin: $(TARGET).elf
	$(OBJCOPY) -O binary $^ $@

# Rule to link the objects and create the final ELF
$(TARGET).elf: $(OBJS)
	$(CC) $(CFLAGS) -o $@ $(OBJS)

# Generic rules for compiling/assembling
%.o: %.S
	$(CC) $(CFLAGS) -c -o $@ $<

# Target to clean the generated files
clean:
	rm -f *.o *.elf *.bin *.hex
